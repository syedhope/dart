# ==============================================================================
# File Location: dart-agent/scenarios/05_vendor_deadlock.yaml
# Description:
#   Scenario 5: Vendor Deadlock (Loop Demo).
#   Pass 1: SQL cleanup fails because stage table is locked by the vendor sync.
#   Pass 2: Syx triggers the vendor cursor reset tool, then SQL succeeds.
# ==============================================================================

scenario_id: "SCN_005_DEADLOCK"
difficulty: "HARD"
description: "Vendor API duplication causes Snowflake constraint failures until the cursor is reset."

trigger_alert:
  id: "ALERT_DEADLOCK_712"
  source_system: "Airflow"
  error_code: "ERROR_DEADLOCK_712"
  message: "Vendor ingest failed: duplicate payload IDs caused constraint violation. Stage table locked."
  severity: "CRITICAL"
  metadata:
    mission_name: "Agent Loop"
    dag_id: "vendor_ingest_nightly"
    job_id: "vendor_payload_sync"
    requires_vendor_reset: false
    enable_vendor_dr: false
    force_db_checks: true
    disable_drift: true
    expected_fix: "stage_cleanup"
    loop_strategy_hint: "reset_vendor_cursor"

environment_state:
  loop_control:
    require_vendor_reset: false
    vendor_reset_recovered: true
  snowflake_schema:
    table: "SALES_DATA"
    columns: ["id", "date", "amount", "store_id", "region", "status"]
  incoming_file_header:
    columns: ["id", "date", "amount", "store_id", "region", "status"]
  logs:
    - service: "airflow_worker"
      level: "ERROR"
      content: "ERROR_DEADLOCK_712: Duplicate payload_id detected. Stage table SALES_DATA locked by vendor sync."
    - service: "airflow_scheduler"
      level: "WARNING"
      content: "Retry exhausted for task vendor_payload_sync. Suggest vendor reset."
  vendor_behavior:
    mode: "HONEST"
    actual_status: "DEGRADED"
    public_statement: "Degradation acknowledged. Reset cursor if lock persists."
